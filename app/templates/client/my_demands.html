{% extends "base.html" %}
{% block title %}Minhas Demandas - Organiums{% endblock %}
{% block include_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/kanban.css') }}">
<style>
.kanban-card {
  cursor: pointer;
  transition: var(--transition);
  margin-bottom: var(--spacing-md);
  background: var(--surface);
  color: var(--fg);
  border-radius: var(--radius);
  padding: var(--spacing-sm);
}

.kanban-card:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
}

.empty-card {
  text-align: center;
  padding: var(--spacing-2xl);
  color: var(--muted);
  font-style: italic;
  background: var(--bg-light);
  border-radius: var(--radius);
}

.my-demands-header {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  /* vocÃª pode deixar esse degradÃª fixo se for marca, ou parametrizar */
  color: #fff;
  padding: var(--spacing-2xl) var(--spacing-xl);
  border-radius: var(--radius-lg);
  margin-bottom: var(--spacing-2xl);
}

.my-demands-header h1 {
  margin: 0;
  font-size: var(--text-3xl);
  color: #fff;
}

.my-demands-header p {
  margin: var(--spacing-sm) 0 0 0;
  opacity: 0.9;
  color: #fdfdfd;
}

.stats-cards {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: var(--spacing-md);
  margin-bottom: var(--spacing-2xl);
}

.stat-card {
  background: var(--surface);
  padding: var(--spacing-xl);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  text-align: center;
  color: var(--fg);
}

.stat-number {
  font-size: var(--text-3xl);
  font-weight: bold;
  color: var(--brand-primary);
}

.stat-label {
  color: var(--muted);
  font-size: var(--text-sm);
}
</style>
{% endblock %}

{% block content %}
<div class="container client-section">
    <div class="my-demands-header">
        <h1>ðŸ“‹ Minhas Demandas</h1>
        <p>Visualize todas as tarefas atribuÃ­das a vocÃª ou criadas por vocÃª</p>
    </div>

    <!-- EstatÃ­sticas rÃ¡pidas -->
    <div class="stats-cards">
        <div class="stat-card">
            <div class="stat-number" id="totalCards">0</div>
            <div class="stat-label">Total de Tarefas</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="pendingCards">0</div>
            <div class="stat-label">Pendentes</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="urgentCards">0</div>
            <div class="stat-label">Urgentes</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="lateCards">0</div>
            <div class="stat-label">Atrasadas</div>
        </div>
    </div>

    <!-- Seletor de Quadro -->
    <div class="kanban-header">
        <h2>Quadros com suas demandas</h2>
        <select id="kanbanSelector" onchange="loadMyKanban(this.value)">
            <option value="">Selecione um quadro...</option>
            {% for board in kanban_boards %}
            <option value="{{ board.id }}">{{ board.name }}</option>
            {% endfor %}
        </select>
    </div>

    <!-- Container do Kanban -->
    <div id="kanbanContainer" class="kanban-container">
        <div class="empty-state" id="emptyState">
            <p>Selecione um quadro para visualizar suas demandas</p>
        </div>
    </div>
</div>

<!-- Modal para visualizaÃ§Ã£o detalhada (reutilizamos o mesmo modal) -->
<div id="cardModal" class="modal">
    <div class="modal-content large">
        <span class="close" onclick="closeModal('cardModal')">&times;</span>
        <h2>Detalhes da Demanda</h2>
        <div id="cardDetails">
            <!-- ConteÃºdo serÃ¡ preenchido via JavaScript -->
        </div>
    </div>
</div>
{% endblock %}

{% block include_js %}
<script src="{{ url_for('static', filename='js/my_demands.js') }}"></script>
<script>
// Dados globais - CORRIGIDO: sem duplicaÃ§Ã£o
const currentUserId = {{ current_user.id }};
const myKanbanData = {{ kanban_boards|tojson|safe }};
const currentUserRole = "{{ current_user.role }}";

console.log("Dados carregados:", myKanbanData);
console.log("User ID:", currentUserId);

// InicializaÃ§Ã£o especÃ­fica para minha visÃ£o
document.addEventListener('DOMContentLoaded', function() {
    calculateMyStats();
    
    // Se hÃ¡ apenas um quadro, carregar automaticamente
    if (myKanbanData.length === 1) {
        document.getElementById('kanbanSelector').value = myKanbanData[0].id;
        loadMyKanban(myKanbanData[0].id);
    }
    
    // Definir funÃ§Ã£o global
    window.loadMyKanban = function(boardId) {
        if (window.myDemandsManager) {
            window.myDemandsManager.loadMyKanban(boardId);
        }
    };
});

function calculateMyStats() {
    let total = 0;
    let pending = 0;
    let urgent = 0;
    let late = 0;
    const today = new Date();

    console.log("Calculando estatÃ­sticas para", myKanbanData.length, "quadros");

    myKanbanData.forEach(board => {
        console.log("Quadro:", board.name, "com", board.columns.length, "colunas");
        
        board.columns.forEach(column => {
            console.log("Coluna:", column.name, "com", column.cards.length, "cards");
            
            column.cards.forEach(card => {
                total++;
                
                // Pendentes (nÃ£o estÃ£o em "Done")
                if (column.name !== 'Done' && column.name !== 'ConcluÃ­do') {
                    pending++;
                }
                
                // Urgentes (GUT score alto ou prazo prÃ³ximo)
                const gutScore = card.gravidade * card.urgencia * card.tendencia;
                const prazoDate = card.prazo ? new Date(card.prazo) : null;
                
                if (gutScore >= 50 || (prazoDate && prazoDate < new Date(today.getTime() + 3 * 24 * 60 * 60 * 1000))) {
                    urgent++;
                }
                
                // Atrasadas
                if (prazoDate && prazoDate < today) {
                    late++;
                }
            });
        });
    });

    console.log("EstatÃ­sticas - Total:", total, "Pendentes:", pending, "Urgentes:", urgent, "Atrasadas:", late);

    document.getElementById('totalCards').textContent = total;
    document.getElementById('pendingCards').textContent = pending;
    document.getElementById('urgentCards').textContent = urgent;
    document.getElementById('lateCards').textContent = late;
}
</script>
{% endblock %}
