{% extends "base.html" %}
{% block title %}Gest√£o Estrat√©gica{% endblock %}
{% block content %}
<div class="container client-section">
  <h1>üéØ Gest√£o de Metas, Objetivos e Planos</h1>

  <div class="crud-grid">
    {% for level in ['estrat√©gica', 't√°ticas', 'operacionais'] %}
      <div class="crud-column">
        <h2>{{ level|capitalize }}</h2>

        <!-- METAS -->
        <h3>Metas</h3>
        <ul>
          {% for g in goals if g.level == level %}
            <li>
              <div>
                <strong>{{ g.title }}</strong> - {{ g.description or "-" }}
              </div>
              {% if current_user.is_cliente_adm() or current_user.is_admin() or current_user.is_funcionario() %}
              <div class="actions">
                <button class="btn-edit" data-action="edit" data-type="goal" data-id="{{ g.id }}" data-title="{{ g.title }}" data-description="{{ g.description or '' }}" data-level="{{ level }}">Editar</button>
                <a href="{{ url_for('app_bp.client_goal_delete', id=g.id) }}" class="btn-delete">Excluir</a>
              </div>
              {% endif %}
            </li>
          {% endfor %}
        </ul>
        <button class="btn-add" data-action="create" data-type="goal" data-level="{{ level }}">+ Nova Meta</button>

      </div>
    {% endfor %}
  </div>
</div>

{% endblock %}

{% block include_js %}
<script>
(function(){
  function esc(s){
    if (s === null || s === undefined) return '';
    return String(s)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
  }

  function initGoalModalOverride(){
    const crudModal = document.getElementById('crudModal');
    const crudForm = document.getElementById('crudForm');
    const modalTitle = document.getElementById('modalTitle');
    const formLevel = document.getElementById('formLevel');
    const formId = document.getElementById('formId');
    const formFields = document.getElementById('formFields');

    if (!crudModal || !crudForm || !modalTitle || !formFields) return;

    // guarda refer√™ncias originais (se existirem)
    const origOpenCreate = window.openCreateModal;
    const origOpenEdit = window.openEditModal;

    // Sobrescreve apenas para 'goal'
    window.openCreateModal = function(type, level) {
      if (type === 'goal') {
        modalTitle.innerText = 'Nova Meta';
        crudForm.method = 'POST';
        crudForm.action = '/client/goals/new';
        if (formLevel) formLevel.value = level || '';
        if (formId) formId.value = '';

        formFields.innerHTML = `
          <label>T√≠tulo</label>
          <input type="text" name="title" placeholder="T√≠tulo" value="" required>
          <label>Descri√ß√£o</label>
          <textarea name="description" placeholder="Descri√ß√£o"></textarea>
          <input type="hidden" name="level" value="${esc(level || '')}">
        `;

        crudModal.classList.add('active');
      } else {
        if (typeof origOpenCreate === 'function') {
          origOpenCreate(type, level);
        }
      }
    };

    // itemData ser√° passado pelo listener global do base.html (ele constr√≥i itemData a partir dos data-attributes)
    window.openEditModal = function(type, id, itemData = {}) {
      if (type === 'goal') {
        modalTitle.innerText = 'Editar Meta';
        crudForm.method = 'POST';
        crudForm.action = '/client/goals/' + id + '/edit';
        if (formId) formId.value = id;

        const title = itemData.title || itemData.name || '';
        const description = itemData.description || '';

        const level = itemData.level || '';

        formFields.innerHTML = `
          <label>T√≠tulo</label>
          <input type="text" name="title" placeholder="T√≠tulo" value="${esc(title)}" required>
          <label>Descri√ß√£o</label>
          <textarea name="description" placeholder="Descri√ß√£o">${esc(description)}</textarea>
          <input type="hidden" name="level" value="${esc(level)}">
        `;

        if (formLevel) formLevel.value = level || '';
        crudModal.classList.add('active');
      } else {
        if (typeof origOpenEdit === 'function') {
          origOpenEdit(type, id, itemData);
        }
      }
    };
  }

  // executa mesmo se DOMContentLoaded j√° tiver disparado
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initGoalModalOverride);
  } else {
    initGoalModalOverride();
  }
})();
</script>
{% endblock %}
